version: v1
description: Azure Resource Test

parameters:
  ressource_name:
    description: The ressource name of all ressources
  location:
    description: The location of the all ressource group

steps:
- name: param1
  image: projectnebula/core
  input: 
  -  echo "-------------- PARAMETERS --------------"
  -  echo "Ressource Name ?"
  -  RNAME=$(ni get -p {.ressource_name})
  -  echo ""
  -  echo "Your Storage Account is ${RNAME}"
  spec:
    ressource_name:
      $type: Parameter
      name: ressource_name
- name: param2
  image: projectnebula/core
  dependsOn: param1
  input: 
  -  echo "-------------- PARAMETERS --------------"
  -  echo "Which location ?"
  -  LOCATION=$(ni get -p {.location})
  -  echo ""
  -  echo "Your Storage Account is ${LOCATION}"
  spec:
    location:
      $type: Parameter
      name: location



- name: arm-deployer-1
  image: projectnebula/azureresourcemanager-deployer:latest
  dependsOn: param2
  spec:
    azure:
      tenantID:
        $type: Secret
        name: tenantID
      username:
        $type: Secret
        name: username
      password:
        $type: Secret
        name: cert
    deploymentName: nebula-test
    templateFile: test-4/rg/deploy.json
    location: centralus
    git:
      name: NebulaTest1
      branch: master
      repository: https://github.com/LynxPantera/nebula-example/
    parameters:
      ressource_name: !Fn.concat [rg-az-lab-, !Parameter ressource_name]
      location: !Parameter location



- name: arm-deployer-2
  image: projectnebula/azureresourcemanager-deployer:latest
  dependsOn: arm-deployer-1
  spec:
    azure:
      tenantID:
        $type: Secret
        name: tenantID
      username:
        $type: Secret
        name: username
      password:
        $type: Secret
        name: cert
    deploymentName: nebula-test
    templateFile: test-4/sn/deploy.json
    resourceGroup: rg-az-lab-rlx-author
    git:
      name: NebulaTest1
      branch: master
      repository: https://github.com/LynxPantera/nebula-example/



- name: arm-deployer-3
  image: projectnebula/azureresourcemanager-deployer:latest
  dependsOn: arm-deployer-2
  spec:
    azure:
      tenantID:
        $type: Secret
        name: tenantID
      username:
        $type: Secret
        name: username
      password:
        $type: Secret
        name: cert
    deploymentName: nebula-test
    templateFile: test-4/nsg/deploy.json
    resourceGroup: !Fn.concat [rg-az-lab-, !Parameter ressource_name]
    git:
      name: NebulaTest1
      branch: master
      repository: https://github.com/LynxPantera/nebula-example/
    parameters:
      location: !Parameter location
      nsg_name: !Fn.concat [nsg-az-lab-, !Parameter ressource_name]



- name: arm-deployer-4
  image: projectnebula/azureresourcemanager-deployer:latest
  dependsOn: arm-deployer-3
  spec:
    azure:
      tenantID:
        $type: Secret
        name: tenantID
      username:
        $type: Secret
        name: username
      password:
        $type: Secret
        name: cert
    deploymentName: nebula-test
    templateFile: test-4/ip_pub/deploy.json
    resourceGroup: !Fn.concat [rg-az-lab-, !Parameter ressource_name]
    git:
      name: NebulaTest1
      branch: master
      repository: https://github.com/LynxPantera/nebula-example/
    parameters:
      location: !Parameter location
      ip_name: !Fn.concat [ip-az-lab-, !Parameter ressource_name]



- name: arm-deployer-5
  image: projectnebula/azureresourcemanager-deployer:latest
  dependsOn: arm-deployer-4
  spec:
    azure:
      tenantID:
        $type: Secret
        name: tenantID
      username:
        $type: Secret
        name: username
      password:
        $type: Secret
        name: cert
    deploymentName: nebula-test
    templateFile: test-4/nic/deploy.json
    resourceGroup: !Fn.concat [rg-az-lab-, !Parameter ressource_name]
    git:
      name: NebulaTest1
      branch: master
      repository: https://github.com/LynxPantera/nebula-example/
    parameters:
      location: !Parameter location
      nic_name: !Fn.concat [ip-az-lab-, !Parameter ressource_name]
      $type: Secret
        name: sub_id
